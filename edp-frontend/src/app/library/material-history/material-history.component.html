<div class="history-container">
  @if (isLoading()) {
  <div class="loading-spinner">
    <mat-spinner></mat-spinner>
  </div>
  } @else if (error()) {
  <mat-card class="error-card mat-elevation-z2">{{ error() }}</mat-card>
  } @else if (submissionHistory() && submissionHistory()!.content.length > 0) {
  <mat-toolbar color="primary" class="history-toolbar mat-elevation-z4">
    <h1 class="history-title">Submission History</h1>
    <span class="toolbar-spacer"></span>
    <button
      mat-icon-button
      [routerLink]="['/library', materialType(), materialId()]"
      aria-label="Back to material details"
    >
      <mat-icon>arrow_back</mat-icon>
    </button>
  </mat-toolbar>

  <div class="submissions-list">
    <mat-accordion multi>
      @for (submission of submissionHistory()!.content; track submission.id) {
      <mat-expansion-panel class="submission-panel mat-elevation-z1">
        <mat-expansion-panel-header class="submission-header">
          <mat-panel-title class="submission-header-title">
            <span class="submission-id">Submission #{{ submission.id }}</span>
            <app-custom-tag
              [tagName]="submission.status"
              [status]="submission.status"
            />
          </mat-panel-title>
          <mat-panel-description class="submission-header-subtitle">
            <mat-icon class="submission-header-icon">calendar_today</mat-icon>
            Submitted on {{ submission.submittedAt | date : "medium" }}
          </mat-panel-description>
        </mat-expansion-panel-header>

        <mat-divider></mat-divider>

        <div class="expanded-details">
          <mat-list dense>
            <mat-list-item>
              <mat-icon matListItemIcon>title</mat-icon>
              <div matListItemTitle>Title</div>
              <div matListItemLine>{{ submission.title }}</div>
            </mat-list-item>

            @if (isLearningSubmission(submission)) {
            <mat-list-item>
              <mat-icon matListItemIcon>link</mat-icon>
              <div matListItemTitle>Proof URL</div>
              <a matListItemLine [href]="submission.proofUrl" target="_blank">{{
                submission.proofUrl
              }}</a>
            </mat-list-item>
            } @else {
            <mat-list-item>
              <mat-icon matListItemIcon>description</mat-icon>
              <div matListItemTitle>Description</div>
              <div matListItemLine>{{ submission.description }}</div>
            </mat-list-item>
            <mat-list-item>
              <mat-icon matListItemIcon>insert_drive_file</mat-icon>
              <div matListItemTitle>Document URL</div>
              <a
                matListItemLine
                [href]="submission.documentUrl"
                target="_blank"
                >{{ submission.documentUrl }}</a
              >
            </mat-list-item>
            }
          </mat-list>

          @if (submission.reviewerId || submission.reviewedAt ||
          submission.reviewerComment) {
          <mat-divider></mat-divider>
          <div class="reviewer-info">
            <div class="info-header">
              <mat-icon color="primary">assignment_ind</mat-icon>
              <h3>Reviewer Information</h3>
            </div>
            <mat-list dense>
              @if (submission.reviewerId) {
              <mat-list-item>
                <mat-icon matListItemIcon>person_outline</mat-icon>
                <div matListItemTitle>Reviewed By</div>
                <div matListItemLine>{{ submission.reviewerId }}</div>
              </mat-list-item>
              } @if (submission.reviewedAt) {
              <mat-list-item>
                <mat-icon matListItemIcon>access_time</mat-icon>
                <div matListItemTitle>Reviewed At</div>
                <div matListItemLine>
                  {{ submission.reviewedAt | date : "medium" }}
                </div>
              </mat-list-item>
              } @if (submission.reviewerComment) {
              <mat-list-item>
                <mat-icon matListItemIcon>comment</mat-icon>
                <div matListItemTitle>Comment</div>
                <div matListItemLine>{{ submission.reviewerComment }}</div>
              </mat-list-item>
              }
            </mat-list>
          </div>
          } @if (submission.tags && submission.tags.length > 0) {
          <mat-divider></mat-divider>
          <div class="tags-list">
            <div class="info-header">
              <mat-icon color="primary">label</mat-icon>
              <h3>Tags</h3>
            </div>
            <mat-chip-listbox>
              @for (tag of submission.tags; track tag.id) { @if
              (isLearningTag(tag)) {
              <app-custom-tag
                [tagName]="tag.tagName"
                [durationMinutes]="tag.durationMinutes"
              />
              }@else {
              <app-custom-tag [tagName]="tag.tagName" />
              } }
            </mat-chip-listbox>
          </div>
          }
        </div>
      </mat-expansion-panel>
      }
    </mat-accordion>
  </div>

  <mat-paginator
    class="history-paginator mat-elevation-z2"
    [length]="totalElements()"
    [pageSize]="pageSize()"
    [pageIndex]="pageIndex()"
    [pageSizeOptions]="[5, 10, 20]"
    aria-label="Select page"
    (page)="handlePageEvent($event)"
  />
  } @else {
  <mat-card class="no-history-card mat-elevation-z2">
    <mat-card-content class="no-history-message">
      <mat-icon class="no-history-icon" color="accent">info_outline</mat-icon>
      <h2>No Submission History</h2>
      <p>There are no submissions to display for this material yet.</p>
      <button
        mat-flat-button
        color="primary"
        [routerLink]="['/library', materialType(), materialId()]"
      >
        <mat-icon>arrow_back</mat-icon>
        Go Back
      </button>
    </mat-card-content>
  </mat-card>
  }
</div>
