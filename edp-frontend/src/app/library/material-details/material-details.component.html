<div class="details-container">
  @if (isLoading()) {
  <div class="loading-spinner">
    <mat-spinner></mat-spinner>
  </div>
  } @else if (error()) {
  <div class="error-message">
    <mat-card>{{ error() }}</mat-card>
  </div>
  } @else if (material()) {
  <mat-toolbar class="header-toolbar">
    <h1 class="page-title">{{ material()?.title }}</h1>
    @if (isOwner() && isRejected()) {
    <button
      mat-flat-button
      class="edit-button"
      [routerLink]="[`/library/edit-${materialType()}`, material()?.id]"
    >
      <mat-icon>edit</mat-icon>
      Edit
    </button>
    }
    <button
      mat-button
      color="accent"
      [routerLink]="['/library/history', materialType(), material()?.id]"
    >
      <mat-icon>history</mat-icon>
      History
    </button>
  </mat-toolbar>

  <mat-card class="material-card">
    <mat-card-header>
      <div class="header-content">
        <mat-card-title>Details</mat-card-title>
        <div class="status-container">
          <span class="status-label">Status:</span>
          <app-custom-tag
            [tagName]="material()?.status!"
            [status]="material()?.status!"
          />
        </div>
      </div>
    </mat-card-header>

    <mat-card-content>
      <div class="detail-rows-container">
        <div class="detail-row">
          <span class="label">ID</span>
          <span>{{ material()?.id }}</span>
        </div>

        @if (learningMaterial) {
        <div class="detail-row">
          <span class="label">Proof URL</span>
          <a [href]="learningMaterial.proofUrl" target="_blank">
            {{ learningMaterial.proofUrl }}
          </a>
        </div>
        } @else if (blogOrWikiMaterial) {
        <!-- Display file download link and an embed view if the URL exists -->
        @if (fileDataUrl()) {
        <div class="detail-row">
          <span class="label">Document</span>
          <a [href]="fileDataUrl()!" target="_blank" download>
            Download Document
          </a>
        </div>

        <div class="detail-row">
          <span class="label">Description</span>
          <p class="description-text">{{ blogOrWikiMaterial.description }}</p>
        </div>

        <div class="file-viewer-container">
          <!-- A simple iframe to embed the document for viewing -->
          <iframe
            [src]="fileDataUrl()!"
            frameborder="0"
            class="file-iframe"
          ></iframe>
        </div>
        } }
      </div>

      <mat-divider></mat-divider>

      <div class="tags-section">
        <h3>Tags</h3>
        <div class="tags-list">
          @if (isLearning(material())) { @for (tag of learningTags; track
          tag.id) {
          <app-custom-tag
            [tagName]="tag.tagName"
            [durationMinutes]="tag.durationMinutes"
          />
          } } @else { @for (tag of material()?.tags ?? []; track tag.id) {
          <app-custom-tag [tagName]="tag.tagName" />
          } }
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- New section for manager's review actions -->
  @if (isManager() && isPending()) {
  <mat-card class="review-actions-card">
    <mat-card-header>
      <mat-card-title>Review Submission</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="review-selection">
        <mat-button-toggle-group
          name="reviewStatus"
          [ngModel]="selectedReviewAction()"
          (ngModelChange)="selectedReviewAction.set($event)"
          aria-label="Review decision"
        >
          <mat-button-toggle value="APPROVED" class="approve-toggle">
            <mat-icon>check_circle</mat-icon>
            Approve
          </mat-button-toggle>

          <mat-button-toggle value="REJECTED" class="reject-toggle">
            <mat-icon>cancel</mat-icon>
            Reject
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      @if (selectedReviewAction() === 'REJECTED') {
      <div class="rejection-form">
        <mat-form-field appearance="outline" class="rejection-textarea">
          <mat-label>Rejection Comment (Min. 10 characters)</mat-label>
          <textarea
            matInput
            rows="3"
            [ngModel]="rejectionComment()"
            (ngModelChange)="rejectionComment.set($event)"
            required
            minlength="10"
          ></textarea>
        </mat-form-field>
      </div>
      }

      <button
        mat-raised-button
        color="primary"
        class="submit-review-button"
        (click)="
          onSubmitReview(
            selectedReviewAction() === 'REJECTED' ? 'REJECTED' : 'APPROVED'
          )
        "
        [disabled]="
          !selectedReviewAction() ||
          (selectedReviewAction() === 'REJECTED' &&
            rejectionComment().length < 10)
        "
      >
        Submit Review
      </button>
    </mat-card-content>
  </mat-card>
  } }
</div>
