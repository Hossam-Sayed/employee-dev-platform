<div class="container py-4">
  @if (loading()) {
    <div class="d-flex justify-content-center my-5">
      <mat-spinner></mat-spinner>
    </div>
  } @else if (submissionData()) {
    <mat-card class="p-4 mb-4 mat-elevation-z3">
      <mat-card-header class="d-flex align-items-center mb-3 justify-content-between">
        <mat-card-title class="mb-0">
          <h2 class="mb-0">Submission Details:  {{ submissionData()!.user.firstName }} {{ submissionData()!.user.lastName }}</h2>
        </mat-card-title>
        <button mat-icon-button color="primary" routerLink="/career-package/my-package" matTooltip="Back to My Package">
          <mat-icon>arrow_back</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content class="mt-3">
        <div class="row g-3">
          <div class="col-md-6">
            <p class="mb-1"><strong>Email:</strong> {{ submissionData()!.user.email }}</p>
            <p class="mb-1"><strong>Department:</strong> {{ submissionData()!.department }}</p>
            <p class="mb-1"><strong>Position:</strong> {{ submissionData()!.position }}</p>
          </div>
          <div class="col-md-6">
            <p class="mb-1"><strong>Status:</strong>
              <span class="badge ms-2"
                [ngClass]="{
                  'bg-success': submissionData()!.status === 'APPROVED',
                  'bg-warning text-dark': submissionData()!.status === 'PENDING',
                  'bg-danger': submissionData()!.status === 'REJECTED'
                }"
              >
                {{ submissionData()!.status }}
              </span>
            </p>
            <p class="mb-1"><strong>Submitted At:</strong> {{ submissionData()!.submittedAt | date:'yyyy-MM-dd HH:mm' }}</p>
            <p class="mb-1"><strong>Reviewed At:</strong> {{ submissionData()!.reviewedAt | date:'yyyy-MM-dd HH:mm'}}</p>
          </div>
        </div>
        <div class="mt-3">
          <p class="lead mb-1"><strong>Manager Comment:</strong></p>
          <p class="comment-text">{{ submissionData()!.comment || 'No comment provided.' }}</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="p-4 mat-elevation-z3">
      <mat-card-header>
        <mat-card-title>Sections</mat-card-title>
      </mat-card-header>
      <mat-card-content class="mt-3">
        @if (submissionData()!.sections && submissionData()!.sections.length > 0) {
          <mat-accordion multi>
            @for (section of submissionData()!.sections; track section.sectionId) {
              <mat-expansion-panel class="mb-2">
                <mat-expansion-panel-header class="d-flex flex-column align-items-start">
                  <mat-panel-title class="d-flex align-items-center justify-content-between w-100">
                    <h6 class="fw-bold mb-0 me-2">{{$index+1}}: {{ section.sectionName }}</h6>
                    <span class="text-muted text-sm">{{ section.sectionDescription }}</span>
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <div class="p-3">
                  <h4 class="mb-3">Tags in this Section:</h4>
                  @if (section.tags && section.tags.length > 0) {
                    @for (tag of section.tags; track tag.tagName) {
                      <div class="mb-3 p-3 border rounded">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                          <span class="fw-semibold me-2">{{ tag.tagName }}:</span>
                          @if (tag.criteriaType === 'BOOLEAN') {
                            <span [ngClass]="{'text-success': tag.submittedValue === 1, 'text-danger': tag.submittedValue === 0}">
                              {{ tag.submittedValue === 1 ? 'Done' : 'Missing' }}
                            </span>
                          } @else {
                            <span>
                              {{ tag.submittedValue }} / {{ tag.requiredValue }} {{ tag.criteriaType }}
                            </span>
                          }
                        </div>
                        
                        @if (tag.criteriaType !== 'BOOLEAN' && tag.requiredValue > 0) {
                          <mat-progress-bar
                            mode="determinate"
                            [value]="getTagProgressPercent(tag)"
                            class="w-100 mb-2"
                          ></mat-progress-bar>
                        }

                        <p class="mb-2 comment-text">
                          <strong>Proof (Comment/Link): </strong>
                          @if (isUrl(tag.proofLink)) {
                            <a [href]="tag.proofLink" target="_blank" class="text-primary text-decoration-underline">{{ tag.proofLink }}</a>
                          } @else {
                            <span>{{ tag.proofLink || 'N/A' }}</span>
                          }
                        </p>

                        @if (tag.fileId) {
                          <button mat-icon-button color="primary" (click)="viewPdfProof(tag.fileId)" matTooltip="View Document">
                            <mat-icon>description</mat-icon>
                          </button>
                        } @else {
                          <p class="text-muted mb-0">No associated document file.</p>
                        }
                      </div>
                    }
                  } @else {
                    <div class="alert alert-info text-center" role="alert">
                      No tags recorded for this section.
                    </div>
                  }
                </div>
              </mat-expansion-panel>
            }
          </mat-accordion>
        } @else {
          <div class="alert alert-info text-center" role="alert">
            No sections found in this submission snapshot.
          </div>
        }
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="alert alert-danger text-center" role="alert">
      Failed to load submission details. Please try again.
    </div>
  }
</div>